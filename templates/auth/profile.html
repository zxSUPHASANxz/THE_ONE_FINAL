{% extends 'base.html' %}

{% block title %}‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå - THE ONE{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8" x-data="{ editing: false, addingMotorcycle: false }">
    <div class="px-4 py-6 sm:px-0">
        <!-- Profile Card -->
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
                <button @click="editing = !editing" 
                        x-text="editing ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'"
                        :class="editing ? 'btn-secondary' : 'btn-primary'">
                </button>
            </div>
            
            <!-- View Mode -->
            <div x-show="!editing">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <p class="text-gray-900">{{ user.username }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <p class="text-gray-900">{{ user.email }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <p class="text-gray-900">{{ user.get_user_type_display }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <p class="text-gray-900">{{ user.phone_number|default:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                        <p class="text-gray-900">{{ user.address|default:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</p>
                    </div>
                </div>
                
                <div class="mt-6 flex space-x-4">
                    {% if not user.is_mechanic %}
                    <a href="{% url 'booking_list' %}" class="btn-secondary">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
                    {% else %}
                    <a href="{% url 'mechanic_dashboard' %}" class="btn-secondary">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ä‡πà‡∏≤‡∏á</a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Edit Mode -->
            <div x-show="editing" style="display: none;">
                <!-- Alert Container -->
                <div id="profileAlertContainer" class="mb-6"></div>

                <form id="profileForm" method="POST" action="{% url 'profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_profile">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <input type="text" name="username" value="{{ user.username }}" class="input-field" readonly>
                            <p class="text-xs text-gray-500 mt-1">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="email" name="email" value="{{ user.email }}" class="input-field" required>
                            <p id="emailError" class="text-xs text-red-500 hidden mt-1"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <input type="text" value="{{ user.get_user_type_display }}" class="input-field" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" id="phone_number" name="phone_number" value="{{ user.phone_number }}" class="input-field" placeholder="0812345678" pattern="[0-9]{10}" maxlength="10">
                            <p id="phoneError" class="text-xs text-red-500 hidden mt-1"></p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                            <textarea id="address" name="address" rows="3" class="input-field" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á">{{ user.address }}</textarea>
                        </div>
                        
                        <div class="md:col-span-2 border-t pt-4 mt-2">
                            <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                    <div class="relative">
                                        <input type="password" id="current_password" name="current_password" class="input-field pr-12" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô">
                                        <button type="button" id="toggleCurrentPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" tabindex="-1">
                                            <span id="currentPasswordIcon">üëÅÔ∏è</span>
                                        </button>
                                    </div>
                                    <p id="currentPasswordError" class="text-xs text-red-500 hidden mt-1"></p>
                                </div>
                                <div></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                                    <div class="relative">
                                        <input type="password" id="new_password" name="new_password" class="input-field pr-12" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" minlength="8">
                                        <button type="button" id="toggleNewPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" tabindex="-1">
                                            <span id="newPasswordIcon">üëÅÔ∏è</span>
                                        </button>
                                    </div>
                                    <p id="newPasswordError" class="text-xs text-red-500 hidden mt-1"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                                    <div class="relative">
                                        <input type="password" id="confirm_password" name="confirm_password" class="input-field pr-12" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" minlength="8">
                                        <button type="button" id="toggleConfirmPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" tabindex="-1">
                                            <span id="confirmPasswordIcon">üëÅÔ∏è</span>
                                        </button>
                                    </div>
                                    <p id="confirmPasswordError" class="text-xs text-red-500 hidden mt-1"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-4">
                        <button type="submit" id="profileSubmitBtn" class="btn-primary">
                            <span id="profileSubmitText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>
                            <span id="profileSubmitSpinner" class="hidden">
                                <svg class="animate-spin h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                        <button type="button" @click="editing = false" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Motorcycles Section (Only for customers) -->
        {% if not user.is_mechanic %}
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üèçÔ∏è ‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button @click="addingMotorcycle = !addingMotorcycle" 
                        x-text="addingMotorcycle ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ'"
                        :class="addingMotorcycle ? 'btn-secondary' : 'btn-primary'">
                </button>
            </div>

            <!-- Add Motorcycle Form -->
            <div x-show="addingMotorcycle" x-transition class="mb-6 p-4 bg-gradient-to-r from-red-50 to-amber-50 rounded-lg" style="display: none;">
                <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h3>
                
                <!-- Alert Container -->
                <div id="motorcycleAlertContainer" class="mb-4"></div>

                <form id="addMotorcycleForm" method="POST" action="{% url 'profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_motorcycle">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ *</label>
                            <input type="text" id="moto_brand" name="brand" class="input-field" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Honda, Yamaha">
                            <p id="motoBrandError" class="text-xs text-red-500 hidden mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏∏‡πà‡∏ô *</label>
                            <input type="text" id="moto_model" name="model" class="input-field" required placeholder="‡πÄ‡∏ä‡πà‡∏ô CBR650R, MT-09">
                            <p id="motoModelError" class="text-xs text-red-500 hidden mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ *</label>
                            <input type="number" id="moto_year" name="year" class="input-field" required min="1990" max="2030" placeholder="2024">
                            <p id="motoYearError" class="text-xs text-red-500 hidden mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ã‡∏µ‡∏ã‡∏µ *</label>
                            <input type="number" id="moto_cc" name="cc" class="input-field" required min="150" placeholder="650">
                            <p id="motoCcError" class="text-xs text-red-500 hidden mt-1"></p>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button type="submit" id="motorcycleSubmitBtn" class="btn-primary">
                            <span id="motorcycleSubmitText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                            <span id="motorcycleSubmitSpinner" class="hidden">
                                <svg class="animate-spin h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                        <button type="button" @click="addingMotorcycle = false" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>

            <!-- Motorcycle List -->
            {% if motorcycles %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for motorcycle in motorcycles %}
                <div class="p-4 border-2 border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-lg transition-all duration-300">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-900">{{ motorcycle.brand }} {{ motorcycle.model }}</h3>
                        <span class="badge-gold">{{ motorcycle.cc }} cc</span>
                    </div>
                    <div class="space-y-1 text-sm text-gray-600">
                        <p><strong>‡∏õ‡∏µ:</strong> {{ motorcycle.year }}</p>
                        <p><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> {{ motorcycle.created_at|date:"d/m/Y" }}</p>
                    </div>
                    <form method="POST" action="{% url 'profile' %}" class="mt-3" onsubmit="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ?')">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_motorcycle">
                        <input type="hidden" name="motorcycle_id" value="{{ motorcycle.id }}">
                        <button type="submit" class="text-red-600 hover:text-red-800 text-sm font-medium">üóëÔ∏è ‡∏•‡∏ö</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <p class="text-gray-500 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</p>
                <button @click="addingMotorcycle = true" class="btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏Ñ‡∏±‡∏ô‡πÅ‡∏£‡∏Å</button>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
    // ==================== Profile Form JavaScript ====================
    
    const profileForm = document.getElementById('profileForm');
    const profileSubmitBtn = document.getElementById('profileSubmitBtn');
    const profileSubmitText = document.getElementById('profileSubmitText');
    const profileSubmitSpinner = document.getElementById('profileSubmitSpinner');
    const profileAlertContainer = document.getElementById('profileAlertContainer');

    // Input fields
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone_number');
    const addressInput = document.getElementById('address');
    const currentPasswordInput = document.getElementById('current_password');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');

    // Error elements
    const emailError = document.getElementById('emailError');
    const phoneError = document.getElementById('phoneError');
    const currentPasswordError = document.getElementById('currentPasswordError');
    const newPasswordError = document.getElementById('newPasswordError');
    const confirmPasswordError = document.getElementById('confirmPasswordError');

    // Toggle password buttons
    const toggleCurrentPassword = document.getElementById('toggleCurrentPassword');
    const toggleNewPassword = document.getElementById('toggleNewPassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const currentPasswordIcon = document.getElementById('currentPasswordIcon');
    const newPasswordIcon = document.getElementById('newPasswordIcon');
    const confirmPasswordIcon = document.getElementById('confirmPasswordIcon');

    // Show alert
    function showProfileAlert(message, type = 'info') {
        const colors = {
            success: 'bg-green-50 border-green-500 text-green-800',
            error: 'bg-red-50 border-red-500 text-red-800',
            warning: 'bg-yellow-50 border-yellow-500 text-yellow-800',
            info: 'bg-blue-50 border-blue-500 text-blue-800'
        };

        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };

        profileAlertContainer.innerHTML = `
            <div class="${colors[type]} border-l-4 p-4 rounded-lg shadow-md">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">${icons[type]}</span>
                    <p class="font-medium">${message}</p>
                </div>
            </div>
        `;

        profileAlertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        setTimeout(() => {
            profileAlertContainer.innerHTML = '';
        }, 5000);
    }

    // Set loading state
    function setProfileLoading(isLoading) {
        if (isLoading) {
            profileSubmitBtn.disabled = true;
            profileSubmitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            profileSubmitText.classList.add('hidden');
            profileSubmitSpinner.classList.remove('hidden');
        } else {
            profileSubmitBtn.disabled = false;
            profileSubmitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            profileSubmitText.classList.remove('hidden');
            profileSubmitSpinner.classList.add('hidden');
        }
    }

    // Show field error
    function showFieldError(input, errorElement, message) {
        input.classList.add('border-red-500', 'bg-red-50');
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
    }

    // Clear field error
    function clearFieldError(input, errorElement) {
        input.classList.remove('border-red-500', 'bg-red-50');
        input.classList.add('border-green-500', 'bg-green-50');
        errorElement.classList.add('hidden');
    }

    // Validate email
    function validateEmail() {
        const email = emailInput.value.trim();
        const emailPattern = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        
        if (!emailPattern.test(email)) {
            showFieldError(emailInput, emailError, '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return false;
        }
        
        clearFieldError(emailInput, emailError);
        return true;
    }

    // Validate phone
    function validatePhone() {
        const phone = phoneInput.value.trim();
        
        if (phone.length === 0) {
            clearFieldError(phoneInput, phoneError);
            return true;
        }
        
        const phonePattern = /^[0-9]{10}$/;
        if (!phonePattern.test(phone)) {
            showFieldError(phoneInput, phoneError, '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å');
            return false;
        }
        
        if (!phone.startsWith('0')) {
            showFieldError(phoneInput, phoneError, '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0');
            return false;
        }
        
        clearFieldError(phoneInput, phoneError);
        return true;
    }

    // Validate password change
    function validatePasswordChange() {
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // If no password fields are filled, skip validation
        if (!currentPassword && !newPassword && !confirmPassword) {
            return true;
        }
        
        // If any password field is filled, all must be filled
        if (!currentPassword) {
            showFieldError(currentPasswordInput, currentPasswordError, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
            return false;
        }
        
        if (!newPassword) {
            showFieldError(newPasswordInput, newPasswordError, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà');
            return false;
        }
        
        if (newPassword.length < 8) {
            showFieldError(newPasswordInput, newPasswordError, '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
            return false;
        }
        
        if (newPassword !== confirmPassword) {
            showFieldError(confirmPasswordInput, confirmPasswordError, '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
            return false;
        }
        
        clearFieldError(currentPasswordInput, currentPasswordError);
        clearFieldError(newPasswordInput, newPasswordError);
        clearFieldError(confirmPasswordInput, confirmPasswordError);
        return true;
    }

    // Validate profile form
    function validateProfileForm() {
        const isEmailValid = validateEmail();
        const isPhoneValid = validatePhone();
        const isPasswordValid = validatePasswordChange();
        
        return isEmailValid && isPhoneValid && isPasswordValid;
    }

    // Toggle password visibility
    if (toggleCurrentPassword) {
        toggleCurrentPassword.addEventListener('click', () => {
            const type = currentPasswordInput.type === 'password' ? 'text' : 'password';
            currentPasswordInput.type = type;
            currentPasswordIcon.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    }

    if (toggleNewPassword) {
        toggleNewPassword.addEventListener('click', () => {
            const type = newPasswordInput.type === 'password' ? 'text' : 'password';
            newPasswordInput.type = type;
            newPasswordIcon.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    }

    if (toggleConfirmPassword) {
        toggleConfirmPassword.addEventListener('click', () => {
            const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
            confirmPasswordInput.type = type;
            confirmPasswordIcon.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    }

    // Real-time validation
    if (emailInput) emailInput.addEventListener('blur', validateEmail);
    if (phoneInput) phoneInput.addEventListener('blur', validatePhone);
    if (newPasswordInput) newPasswordInput.addEventListener('input', () => {
        if (newPasswordInput.value.length > 0) {
            validatePasswordChange();
        }
    });
    if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', () => {
        if (confirmPasswordInput.value.length > 0) {
            validatePasswordChange();
        }
    });

    // Handle profile form submission
    if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            profileAlertContainer.innerHTML = '';
            
            if (!validateProfileForm()) {
                showProfileAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            const formData = new FormData(profileForm);
            const csrfToken = formData.get('csrfmiddlewaretoken');
            
            setProfileLoading(true);
            
            try {
                const response = await fetch('/api/profile/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        email: emailInput.value.trim(),
                        phone_number: phoneInput.value.trim() || null,
                        address: addressInput.value.trim() || null,
                        current_password: currentPasswordInput.value || null,
                        new_password: newPasswordInput.value || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showProfileAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                    // Clear password fields
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showProfileAlert(data.message || data.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }
            } catch (error) {
                showProfileAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
            } finally {
                setProfileLoading(false);
            }
        });
    }

    // ==================== Add Motorcycle Form JavaScript ====================
    
    const addMotorcycleForm = document.getElementById('addMotorcycleForm');
    const motorcycleSubmitBtn = document.getElementById('motorcycleSubmitBtn');
    const motorcycleSubmitText = document.getElementById('motorcycleSubmitText');
    const motorcycleSubmitSpinner = document.getElementById('motorcycleSubmitSpinner');
    const motorcycleAlertContainer = document.getElementById('motorcycleAlertContainer');

    // Show motorcycle alert
    function showMotorcycleAlert(message, type = 'info') {
        const colors = {
            success: 'bg-green-50 border-green-500 text-green-800',
            error: 'bg-red-50 border-red-500 text-red-800',
            warning: 'bg-yellow-50 border-yellow-500 text-yellow-800',
            info: 'bg-blue-50 border-blue-500 text-blue-800'
        };

        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };

        motorcycleAlertContainer.innerHTML = `
            <div class="${colors[type]} border-l-4 p-3 rounded-lg">
                <div class="flex items-center">
                    <span class="text-xl mr-2">${icons[type]}</span>
                    <p class="font-medium text-sm">${message}</p>
                </div>
            </div>
        `;

        setTimeout(() => {
            motorcycleAlertContainer.innerHTML = '';
        }, 5000);
    }

    // Set motorcycle loading
    function setMotorcycleLoading(isLoading) {
        if (isLoading) {
            motorcycleSubmitBtn.disabled = true;
            motorcycleSubmitBtn.classList.add('opacity-75');
            motorcycleSubmitText.classList.add('hidden');
            motorcycleSubmitSpinner.classList.remove('hidden');
        } else {
            motorcycleSubmitBtn.disabled = false;
            motorcycleSubmitBtn.classList.remove('opacity-75');
            motorcycleSubmitText.classList.remove('hidden');
            motorcycleSubmitSpinner.classList.add('hidden');
        }
    }

    // Handle motorcycle form submission
    if (addMotorcycleForm) {
        addMotorcycleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            motorcycleAlertContainer.innerHTML = '';
            
            const formData = new FormData(addMotorcycleForm);
            const csrfToken = formData.get('csrfmiddlewaretoken');
            
            setMotorcycleLoading(true);
            
            try {
                // For now, submit traditionally since we need proper API endpoint
                addMotorcycleForm.submit();
            } catch (error) {
                showMotorcycleAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                setMotorcycleLoading(false);
            }
        });
    }
</script>

{% endblock %}
