{% extends 'base.html' %}

{% block title %}AI Chatbot - THE ONE{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 300px);
        min-height: 500px;
    }
    
    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message-enter {
        animation: slideUp 0.3s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-8">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-900 to-purple-800 rounded-2xl shadow-2xl p-6 mb-6 border border-purple-700">
            <div class="flex items-center space-x-4">
                <div class="text-5xl animate-bounce">ü§ñ</div>
                <div>
                    <h1 class="text-3xl font-bold text-white mb-1">AI Chatbot</h1>
                    <p class="text-purple-200">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå</p>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="bg-gray-800 border-2 border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
            <!-- Chat Messages Area -->
            <div class="chat-container overflow-y-auto p-6 space-y-4" id="chatMessages">
                <!-- Welcome Message -->
                <div class="flex justify-start message-enter">
                    <div class="message-bubble bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-2xl rounded-tl-none px-6 py-4 shadow-lg">
                        <div class="flex items-start space-x-3">
                            <div class="text-3xl">ü§ñ</div>
                            <div>
                                <p class="font-semibold mb-2">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà THE ONE</p>
                                <p class="text-sm text-purple-100">‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                                <div class="mt-3 space-y-2">
                                    <p class="text-xs text-purple-200">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:</p>
                                    <ul class="text-xs text-purple-100 space-y-1 ml-4">
                                        <li>üîß ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ</li>
                                        <li>üõ†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏ñ</li>
                                        <li>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
                                        <li>üìã ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Message Example (Hidden by default) -->
                <div class="flex justify-end message-enter" style="display: none;" data-template="user">
                    <div class="message-bubble bg-gradient-to-r from-gold-500 to-gold-600 text-white rounded-2xl rounded-tr-none px-6 py-4 shadow-lg">
                        <p class="message-text"></p>
                    </div>
                </div>

                <!-- Bot Message Example (Hidden by default) -->
                <div class="flex justify-start message-enter" style="display: none;" data-template="bot">
                    <div class="message-bubble bg-gray-700 border border-gray-600 text-white rounded-2xl rounded-tl-none px-6 py-4 shadow-lg">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">ü§ñ</div>
                            <div class="message-text"></div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator (Hidden by default) -->
                <div class="flex justify-start" id="typingIndicator" style="display: none;">
                    <div class="message-bubble bg-gray-700 border border-gray-600 text-white rounded-2xl rounded-tl-none px-6 py-4 shadow-lg">
                        <div class="flex items-center space-x-3">
                            <div class="text-2xl">ü§ñ</div>
                            <div class="flex space-x-2">
                                <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                                <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                                <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggested Questions -->
            <div class="border-t border-gray-700 px-6 py-4 bg-gray-900/50">
                <p class="text-gray-400 text-xs mb-3">üí¨ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏°‡∏ö‡πà‡∏≠‡∏¢:</p>
                <div class="flex flex-wrap gap-2">
                    <button class="suggested-question px-4 py-2 bg-gray-700 hover:bg-purple-600 text-gray-300 hover:text-white text-sm rounded-lg transition-all duration-200 border border-gray-600 hover:border-purple-500">
                        ‡∏£‡∏ñ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡πÅ‡∏Å‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á?
                    </button>
                    <button class="suggested-question px-4 py-2 bg-gray-700 hover:bg-purple-600 text-gray-300 hover:text-white text-sm rounded-lg transition-all duration-200 border border-gray-600 hover:border-purple-500">
                        ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?
                    </button>
                    <button class="suggested-question px-4 py-2 bg-gray-700 hover:bg-purple-600 text-gray-300 hover:text-white text-sm rounded-lg transition-all duration-200 border border-gray-600 hover:border-purple-500">
                        ‡πÄ‡∏ö‡∏£‡∏Ñ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏´‡∏°?
                    </button>
                    <button class="suggested-question px-4 py-2 bg-gray-700 hover:bg-purple-600 text-gray-300 hover:text-white text-sm rounded-lg transition-all duration-200 border border-gray-600 hover:border-purple-500">
                        ‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-700 p-6 bg-gray-900/50">
                <form id="chatForm" class="flex gap-3">
                    <input 
                        type="text" 
                        id="messageInput"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                        class="flex-1 appearance-none rounded-xl px-6 py-4 border border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                        autocomplete="off">
                    <button 
                        type="submit"
                        class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white px-8 py-4 rounded-xl font-bold transition-all duration-200 transform hover:scale-105 shadow-xl flex items-center space-x-2">
                        <span>‡∏™‡πà‡∏á</span>
                        <span>üöÄ</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const suggestedQuestions = document.querySelectorAll('.suggested-question');

    // Auto-scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add user message
    function addUserMessage(text) {
        const template = document.querySelector('[data-template="user"]');
        const messageDiv = template.cloneNode(true);
        messageDiv.style.display = 'flex';
        messageDiv.removeAttribute('data-template');
        messageDiv.querySelector('.message-text').textContent = text;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Add bot message
    function addBotMessage(text) {
        const template = document.querySelector('[data-template="bot"]');
        const messageDiv = template.cloneNode(true);
        messageDiv.style.display = 'flex';
        messageDiv.removeAttribute('data-template');
        messageDiv.querySelector('.message-text').innerHTML = text;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Show/hide typing indicator
    function setTyping(show) {
        typingIndicator.style.display = show ? 'flex' : 'none';
        if (show) scrollToBottom();
    }

    // Send message to backend
    let isSending = false;  // Prevent duplicate sends
    
    async function sendMessage(message) {
        // Prevent duplicate sends
        if (isSending) {
            console.log('Already sending a message, please wait...');
            return;
        }
        
        isSending = true;
        addUserMessage(message);
        messageInput.value = '';
        messageInput.disabled = true;  // Disable input while sending
        setTyping(true);

        try {
            const response = await fetch('/chatbot/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'same-origin',
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            setTyping(false);
            isSending = false;  // Re-enable sending
            messageInput.disabled = false;  // Re-enable input

            if (data.response) {
                addBotMessage(data.response);
            } else {
                addBotMessage('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        } catch (error) {
            console.error('Chat error:', error);
            setTyping(false);
            isSending = false;  // Re-enable sending on error
            messageInput.disabled = false;  // Re-enable input
            addBotMessage('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        }
    }

    // Helper: Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Form submit handler
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message && !isSending) {  // Check if not already sending
            sendMessage(message);
        }
    });

    // Suggested questions click handler
    suggestedQuestions.forEach(button => {
        button.addEventListener('click', function() {
            if (!isSending) {  // Check if not already sending
                const question = this.textContent;
                sendMessage(question);
            }
        });
    });

    // Focus input on load without causing the page to scroll
    try {
        messageInput.focus({ preventScroll: true });
    } catch (e) {
        // Fallback for older browsers that don't support the option
        messageInput.focus();
    }
});
</script>
{% endblock %}
{% endblock %}
