{% extends 'base.html' %}

{% block title %}Mechanic Dashboard - THE ONE{% endblock %}

{% block content %}
<div class="py-8">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Django Messages ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å-->

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-900 to-blue-800 rounded-2xl shadow-2xl p-8 mb-8 border border-blue-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-6xl">üîß</div>
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">Mechanic Dashboard</h1>
                        <p class="text-blue-200">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, {% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}</p>
                        <p class="text-blue-300 text-sm">@{{ user.username }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-blue-300 text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p class="text-white text-2xl font-bold">{{ today|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8">
            <div class="bg-gradient-to-br from-yellow-500 to-orange-600 rounded-xl shadow-2xl p-6 border-2 border-yellow-400 transform hover:scale-105 transition-all">
                <div class="flex items-center justify-between">
                    <div class="text-5xl">‚è≥</div>
                    <div class="text-right">
                        <p class="text-yellow-100 text-sm font-semibold">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</p>
                        <p class="text-white text-4xl font-black">{{ pending_count|default:0 }}</p>
                    </div>
                </div>
                <div class="mt-3 h-1 bg-yellow-300 rounded-full"></div>
            </div>

            <div class="bg-gradient-to-br from-cyan-500 to-sky-600 rounded-xl shadow-2xl p-6 border-2 border-cyan-400 transform hover:scale-105 transition-all">
                <div class="flex items-center justify-between">
                    <div class="text-5xl">‚úîÔ∏è</div>
                    <div class="text-right">
                        <p class="text-cyan-100 text-sm font-semibold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p class="text-white text-4xl font-black">{{ confirmed_count|default:0 }}</p>
                    </div>
                </div>
                <div class="mt-3 h-1 bg-cyan-300 rounded-full"></div>
            </div>

            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-2xl p-6 border-2 border-blue-400 transform hover:scale-105 transition-all">
                <div class="flex items-center justify-between">
                    <div class="text-5xl">üîß</div>
                    <div class="text-right">
                        <p class="text-blue-100 text-sm font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</p>
                        <p class="text-white text-4xl font-black">{{ in_progress_count|default:0 }}</p>
                    </div>
                </div>
                <div class="mt-3 h-1 bg-blue-300 rounded-full"></div>
            </div>

            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-2xl p-6 border-2 border-green-400 transform hover:scale-105 transition-all">
                <div class="flex items-center justify-between">
                    <div class="text-5xl">‚úÖ</div>
                    <div class="text-right">
                        <p class="text-green-100 text-sm font-semibold">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p class="text-white text-4xl font-black">{{ completed_count|default:0 }}</p>
                    </div>
                </div>
                <div class="mt-3 h-1 bg-green-300 rounded-full"></div>
            </div>

            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-2xl p-6 border-2 border-red-400 transform hover:scale-105 transition-all">
                <div class="flex items-center justify-between">
                    <div class="text-5xl">‚ùå</div>
                    <div class="text-right">
                        <p class="text-red-100 text-sm font-semibold">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</p>
                        <p class="text-white text-4xl font-black">{{ cancelled_by_customer_count|default:0 }}</p>
                    </div>
                </div>
                <div class="mt-3 h-1 bg-red-300 rounded-full"></div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-gradient-to-r from-gray-800 to-gray-900 border-2 border-gray-700 rounded-xl p-2 mb-8 flex flex-wrap gap-2 shadow-xl">
            <button onclick="filterWorks('all')" data-filter="all" class="filter-btn flex-1 min-w-[100px] px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-bold transition-all transform hover:scale-105 shadow-lg">
                <span class="text-lg">üìã</span> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="filterWorks('pending')" data-filter="pending" class="filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg font-bold transition-all transform hover:scale-105">
                <span class="text-lg">‚è≥</span> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
            </button>
            <button onclick="filterWorks('confirmed')" data-filter="confirmed" class="filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg font-bold transition-all transform hover:scale-105">
                <span class="text-lg">‚úîÔ∏è</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            </button>
            <button onclick="filterWorks('in_progress')" data-filter="in_progress" class="filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg font-bold transition-all transform hover:scale-105">
                <span class="text-lg">üîß</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
            </button>
            <button onclick="filterWorks('completed')" data-filter="completed" class="filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg font-bold transition-all transform hover:scale-105">
                <span class="text-lg">‚úÖ</span> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
            </button>
            <button onclick="filterWorks('cancelled')" data-filter="cancelled" class="filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg font-bold transition-all transform hover:scale-105">
                <span class="text-lg">‚ùå</span> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>

        <!-- Custom Confirmation Modal -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 border-2 border-gray-700 transform transition-all">
                <div class="text-center">
                    <div id="modalIcon" class="text-6xl mb-4">‚ùì</div>
                    <h3 id="modalTitle" class="text-2xl font-bold text-white mb-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
                    <p id="modalMessage" class="text-gray-300 mb-6 text-lg"></p>
                </div>
                <div class="flex gap-4">
                    <button id="modalConfirm" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-xl">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                    <button id="modalCancel" class="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-xl">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Work Queue -->
        <div class="bg-gray-800 border-2 border-gray-700 rounded-2xl shadow-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô
            </h2>

            <!-- Table View -->
            {% if work_queues %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-700 border-b-2 border-gray-600">
                            <th class="p-4 text-gray-200 font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-4 text-gray-200 font-bold">‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="p-4 text-gray-200 font-bold">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                            <th class="p-4 text-gray-200 font-bold">‡∏£‡∏ñ</th>
                            <th class="p-4 text-gray-200 font-bold">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
                            <th class="p-4 text-gray-200 font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="workTableBody">
                        {% for work in work_queues %}
                        <tr class="work-row border-b border-gray-600 hover:bg-gray-700 transition-colors" 
                            data-status="{{ work.status }}" 
                            data-booking-status="{{ work.booking.status }}"
                            data-booking-mechanic="{{ work.booking.mechanic_id|default:'' }}"
                            data-current-user="{{ request.user.id }}">
                            <td class="p-4 text-gray-300">
                                {{ work.booking.appointment_date|date:"d/m/Y" }}
                            </td>
                            <td class="p-4 text-gray-300">
                                {{ work.booking.appointment_date|time:"H:i" }} ‡∏ô.
                            </td>
                            <td class="p-4 text-gray-300">
                                <div class="max-w-xs truncate" title="{{ work.booking.problem_description }}">
                                    {{ work.booking.problem_description|truncatewords:10 }}
                                </div>
                            </td>
                            <td class="p-4 text-white font-semibold">
                                {% if work.booking.motorcycle %}
                                    {{ work.booking.motorcycle.brand }} {{ work.booking.motorcycle.model }}
                                    <span class="text-gray-400 text-sm block">{{ work.booking.motorcycle.license_plate }}</span>
                                {% else %}
                                    <span class="text-gray-400">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
                                {% endif %}
                            </td>
                            <td class="p-4 text-gray-300">
                                {% if work.booking.customer %}
                                    <div class="text-white font-semibold">{{ work.booking.customer.first_name }} {{ work.booking.customer.last_name }}</div>
                                    {% if work.booking.customer.phone_number %}
                                        <div class="text-sm text-blue-300 flex items-center">
                                            üìû {{ work.booking.customer.phone_number }}
                                        </div>
                                    {% endif %}
                                    <div class="text-xs text-gray-400">@{{ work.booking.customer.username }}</div>
                                {% else %}
                                    <span class="text-gray-400">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if work.booking.status == 'cancelled' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-900/50 text-red-300 border border-red-500">
                                        ‚ùå ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </span>
                                {% elif work.booking.status == 'confirmed' and work.booking.mechanic != request.user and work.status == 'pending' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-orange-900/50 text-orange-300 border border-orange-500">
                                        ‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                                    </span>
                                {% elif work.status == 'pending' and work.booking.status == 'pending' %}
                                    <button onclick="handleAcceptWork({{ work.id }})" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-sm font-bold rounded-lg transition-all transform hover:scale-105 shadow-lg border border-green-400">
                                        ‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                                    </button>
                                {% elif work.status == 'accepted' and work.booking.status == 'confirmed' %}
                                    <button onclick="handleStartWork({{ work.booking.id }})" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-sm font-bold rounded-lg transition-all transform hover:scale-105 shadow-lg border border-blue-400">
                                        üîß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
                                    </button>
                                {% elif work.booking.status == 'in_progress' %}
                                    <button onclick="handleCompleteWork({{ work.booking.id }})" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white text-sm font-bold rounded-lg transition-all transform hover:scale-105 shadow-lg border border-purple-400">
                                        ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                                    </button>
                                {% elif work.booking.status == 'completed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-900/50 text-green-300 border border-green-500">
                                        üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                                    </span>
                                {% elif work.status == 'rejected' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gray-900/50 text-gray-300 border border-gray-500">
                                        ‚úñ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gray-900/50 text-gray-300 border border-gray-500">
                                        {{ work.get_status_display }}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üì≠</div>
                <p class="text-gray-400 text-xl font-semibold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
            </div>
            {% endif %}
        </div>

        <!-- Original Work Queue Cards -->
        <div class="bg-gray-800 border-2 border-gray-700 rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                ‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô
            </h2>

            <!-- Alert Container -->
            <div id="dashboardAlertContainer" class="mb-6"></div>

            {% if work_queues %}
            <div class="space-y-4" id="workQueueContainer">
                {% for work in work_queues %}
                <div class="work-card bg-gradient-to-br from-gray-700 to-gray-800 border-2 border-gray-600 rounded-xl p-6 hover:border-blue-400 hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02]" 
                     data-status="{{ work.status }}" 
                     data-booking-status="{{ work.booking.status }}"
                     data-booking-mechanic="{{ work.booking.mechanic_id|default:'' }}"
                     data-current-user="{{ request.user.id }}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="text-6xl">üèçÔ∏è</div>
                            <div>
                                <h3 class="text-2xl font-black text-white mb-1">
                                    {% if work.booking.motorcycle %}
                                        {{ work.booking.motorcycle.brand }} {{ work.booking.motorcycle.model }}
                                    {% else %}
                                        {{ work.booking.motorcycle_info|default:"‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå" }}
                                    {% endif %}
                                </h3>
                                <p class="text-gray-400 text-sm">
                                    {% if work.booking.motorcycle %}
                                        üè∑Ô∏è ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: <span class="text-gold-400 font-semibold">{{ work.booking.motorcycle.license_plate }}</span>
                                    {% endif %}
                                </p>
                                <p class="text-gray-400 text-sm">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span class="text-blue-300 font-semibold">{{ work.booking.customer.username }}</span></p>
                                <p class="text-gray-500 text-xs">üìÖ ‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ work.assigned_at|date:"d/m/Y H:i" }} ‡∏ô.</p>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if work.booking.status == 'cancelled' %}
                            <span class="inline-flex items-center px-4 py-2 bg-red-500/30 text-red-300 text-sm font-black rounded-lg border-2 border-red-500 shadow-lg">
                                ‚ùå ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </span>
                            {% elif work.status == 'pending' %}
                            <span class="inline-flex items-center px-4 py-2 bg-yellow-500/30 text-yellow-300 text-sm font-black rounded-lg border-2 border-yellow-500 shadow-lg">
                                <span class="animate-pulse mr-2">‚è≥</span> ‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö
                            </span>
                            {% elif work.status == 'accepted' %}
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-4 py-2 bg-green-500/30 text-green-300 text-sm font-black rounded-lg border-2 border-green-500 shadow-lg">
                                    ‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                </span>
                                {% if work.booking.chat_room %}
                                <a href="{% url 'chat:detail' work.booking.chat_room.id %}" class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-sm font-bold rounded-lg shadow-lg transition-all transform hover:scale-105" title="‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                                    üí¨ ‡πÅ‡∏ä‡∏ó
                                </a>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="inline-flex items-center px-4 py-2 bg-gray-500/30 text-gray-300 text-sm font-black rounded-lg border-2 border-gray-500 shadow-lg">
                                ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                            </span>
                            {% endif %}
                            <p class="text-gray-500 text-xs mt-2">#{{ work.booking.id }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg p-4 border border-gray-500">
                            <p class="text-gray-400 text-xs mb-1 font-semibold">üìÜ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
                            <p class="text-white font-bold text-lg">{{ work.booking.appointment_date|date:"d/m/Y H:i" }} ‡∏ô.</p>
                        </div>
                        <div class="bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg p-4 border border-gray-500">
                            <p class="text-gray-400 text-xs mb-1 font-semibold">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
                            <p class="text-white font-bold text-lg">
                                {% if work.booking.status == 'pending' %}üü° ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                                {% elif work.booking.status == 'confirmed' %}üîµ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                {% elif work.booking.status == 'in_progress' %}üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
                                {% elif work.booking.status == 'completed' %}‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                                {% else %}‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å{% endif %}
                            </p>
                        </div>
                    </div>

                    {% if work.booking.problem_description %}
                    <div class="bg-gradient-to-r from-red-900/30 to-orange-900/30 border-l-4 border-red-500 rounded-lg p-4 mb-4">
                        <p class="text-red-300 text-xs mb-1 font-semibold flex items-center">
                            <span class="text-lg mr-2">‚ö†Ô∏è</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                        </p>
                        <p class="text-gray-200 font-medium">{{ work.booking.problem_description }}</p>
                    </div>
                    {% endif %}

                    <div class="flex gap-3">
                        {% if work.booking.status == 'cancelled' %}
                        <div class="flex-1 bg-gradient-to-r from-red-600/20 to-red-700/20 border-2 border-red-500/50 text-red-400 px-6 py-4 rounded-lg font-black text-lg text-center">
                            ‚ùå ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                        {% elif work.booking.status == 'confirmed' and work.booking.mechanic != request.user and work.status == 'pending' %}
                        <div class="flex-1 bg-gradient-to-r from-orange-600/20 to-yellow-700/20 border-2 border-orange-500/50 text-orange-400 px-6 py-4 rounded-lg font-black text-lg text-center">
                            ‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                        {% elif work.status == 'pending' and work.booking.status == 'pending' %}
                        <button onclick="handleAcceptWork({{ work.id }})" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-4 rounded-lg font-black text-lg transition-all transform hover:scale-105 shadow-xl border-2 border-green-400">
                            ‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
                        </button>
                        <button onclick="handleRejectWork({{ work.id }})" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-4 rounded-lg font-black text-lg transition-all transform hover:scale-105 shadow-xl border-2 border-red-400">
                            ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                        </button>
                        {% elif work.status == 'accepted' and work.booking.status == 'confirmed' %}
                        <button onclick="handleStartWork({{ work.booking.id }})" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-6 py-4 rounded-lg font-black text-lg transition-all transform hover:scale-105 shadow-xl border-2 border-blue-400">
                            üîß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
                        </button>
                        {% if work.booking.chat_room %}
                        <a href="{% url 'chat:detail' work.booking.chat_room.id %}" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-4 rounded-lg font-black text-lg transition-all transform hover:scale-105 shadow-xl border-2 border-green-400 text-center">
                            üí¨ ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                        </a>
                        {% endif %}
                        {% elif work.booking.status == 'in_progress' %}
                        <button onclick="handleCompleteWork({{ work.booking.id }})" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white px-6 py-4 rounded-lg font-black text-lg transition-all transform hover:scale-105 shadow-xl border-2 border-purple-400">
                            ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                        </button>
                        {% if work.booking.chat_room %}
                        <a href="{% url 'chat:detail' work.booking.chat_room.id %}" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-4 rounded-lg font-black text-lg transition-all transform hover:scale-105 shadow-xl border-2 border-green-400 text-center">
                            üí¨ ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                        </a>
                        {% endif %}
                        {% elif work.booking.status == 'completed' %}
                        <div class="flex-1 bg-gray-600 text-gray-400 px-6 py-4 rounded-lg font-black text-lg text-center cursor-not-allowed border-2 border-gray-500">
                            üéâ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-16">
                <div class="text-8xl mb-6">üîß</div>
                <h3 class="text-2xl font-bold text-gray-400 mb-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°</h3>
                <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// ==================== CSRF Token is already defined in base.html ====================

// ==================== Wrapper Functions (Define First!) ====================
// These wrapper functions are called from onclick attributes
function handleAcceptWork(workId) {
    acceptWork(workId).catch(err => console.error('Error in acceptWork:', err));
}

function handleRejectWork(workId) {
    rejectWork(workId).catch(err => console.error('Error in rejectWork:', err));
}

function handleStartWork(bookingId) {
    startWork(bookingId).catch(err => console.error('Error in startWork:', err));
}

function handleCompleteWork(bookingId) {
    completeWork(bookingId).catch(err => console.error('Error in completeWork:', err));
}

// ==================== Custom Confirmation Modal ====================
function showConfirmModal(message, icon = '‚ùì', confirmText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        const modalIcon = document.getElementById('modalIcon');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalCancel = document.getElementById('modalCancel');
        
        // Set content
        modalIcon.textContent = icon;
        modalMessage.textContent = message;
        modalConfirm.textContent = confirmText;
        modalCancel.textContent = cancelText;
        
        // Update button colors based on action
        if (icon === '‚úÖ') {
            modalConfirm.className = 'flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-xl';
        } else if (icon === '‚ùå') {
            modalConfirm.className = 'flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-xl';
        } else if (icon === 'üîß') {
            modalConfirm.className = 'flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-xl';
        } else if (icon === 'üéâ') {
            modalConfirm.className = 'flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-xl';
        }
        
        // Show modal with animation
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('div > div').classList.add('scale-100');
        }, 10);
        
        // Handle confirm
        const handleConfirm = () => {
            modal.classList.add('hidden');
            modalConfirm.removeEventListener('click', handleConfirm);
            modalCancel.removeEventListener('click', handleCancel);
            modal.removeEventListener('click', handleBackdropClick);
            resolve(true);
        };
        
        // Handle cancel
        const handleCancel = () => {
            modal.classList.add('hidden');
            modalConfirm.removeEventListener('click', handleConfirm);
            modalCancel.removeEventListener('click', handleCancel);
            modal.removeEventListener('click', handleBackdropClick);
            resolve(false);
        };
        
        // Handle backdrop click
        const handleBackdropClick = (e) => {
            if (e.target === modal) {
                handleCancel();
            }
        };
        
        modalConfirm.addEventListener('click', handleConfirm);
        modalCancel.addEventListener('click', handleCancel);
        modal.addEventListener('click', handleBackdropClick);
        
        // ESC key to cancel
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                handleCancel();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
    });
}

// ==================== Filter Functions ====================
function filterWorks(status) {
    // Update active button
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(btn => {
        if (btn.dataset.filter === status) {
            btn.className = 'filter-btn flex-1 min-w-[100px] px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold transition-all';
        } else {
            btn.className = 'filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg font-semibold transition-all';
        }
    });

    // Get current user id for comparison
    const currentUserId = document.querySelector('[data-current-user]')?.dataset.currentUser;

    // Filter work cards
    const cards = document.querySelectorAll('.work-card');
    let visibleCount = 0;
    
    cards.forEach(card => {
        const workStatus = card.dataset.status;
        const bookingStatus = card.dataset.bookingStatus;
        const bookingMechanic = card.dataset.bookingMechanic;
        
        let shouldShow = false;
        const isTakenByOther = bookingStatus === 'confirmed' && workStatus === 'pending' && bookingMechanic && bookingMechanic !== currentUserId;
        
        if (status === 'all') {
            shouldShow = true;
        } else if (status === 'pending') {
            shouldShow = workStatus === 'pending' && bookingStatus === 'pending';
        } else if (status === 'confirmed') {
            shouldShow = workStatus === 'accepted' && bookingStatus === 'confirmed';
        } else if (status === 'in_progress') {
            shouldShow = bookingStatus === 'in_progress';
        } else if (status === 'completed') {
            shouldShow = bookingStatus === 'completed';
        } else if (status === 'cancelled') {
            shouldShow = bookingStatus === 'cancelled';
        } else if (status === 'taken') {
            shouldShow = isTakenByOther;
        }
        
        if (shouldShow) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // Show/hide empty state
    const container = document.getElementById('workQueueContainer');
    const emptyState = container?.nextElementSibling;
    
    if (visibleCount === 0 && emptyState) {
        container.style.display = 'none';
        if (emptyState.classList.contains('text-center')) {
            emptyState.style.display = 'block';
        }
    } else if (container) {
        container.style.display = 'block';
        if (emptyState && emptyState.classList.contains('text-center')) {
            emptyState.style.display = 'none';
        }
    }
}

// ==================== Dashboard Alert ====================
const dashboardAlertContainer = document.getElementById('dashboardAlertContainer');

function showDashboardAlert(message, type = 'info') {
    const colors = {
        success: 'bg-green-600 border-green-700',
        error: 'bg-red-600 border-red-700',
        warning: 'bg-yellow-600 border-yellow-700',
        info: 'bg-blue-600 border-blue-700'
    };

    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };

    if (dashboardAlertContainer) {
        dashboardAlertContainer.innerHTML = `
            <div class="${colors[type]} border-2 px-5 py-4 rounded-lg shadow-xl">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">${icons[type]}</span>
                    <p class="text-white font-bold text-base">${message}</p>
                </div>
            </div>
        `;

        dashboardAlertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        setTimeout(() => {
            dashboardAlertContainer.innerHTML = '';
        }, 5000);
    }
}

// ==================== Work Actions (Async Functions) ====================
// Wrapper functions are already defined at the top of script
// Filter function
function filterWorks(status) {
    const cards = document.querySelectorAll('.work-card');
    const tableRows = document.querySelectorAll('.work-row');
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    // Get current user id for comparison
    const currentUserEl = document.querySelector('[data-current-user]');
    const currentUserId = currentUserEl ? currentUserEl.dataset.currentUser : '';
    
    // Update button styles
    filterBtns.forEach(btn => {
        if (btn.dataset.filter === status) {
            btn.className = 'filter-btn flex-1 min-w-[100px] px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-bold transition-all transform hover:scale-105 shadow-lg';
        } else {
            btn.className = 'filter-btn flex-1 min-w-[100px] px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg font-bold transition-all transform hover:scale-105';
        }
    });
    
    // Filter cards
    cards.forEach(card => {
        const cardStatus = card.dataset.status;
        const bookingStatus = card.dataset.bookingStatus;
        const bookingMechanic = card.dataset.bookingMechanic;
        const isTakenByOther = bookingStatus === 'confirmed' && cardStatus === 'pending' && bookingMechanic && bookingMechanic !== currentUserId;
        
        if (status === 'all') {
            card.style.display = 'block';
        } else if (status === 'pending') {
            card.style.display = (cardStatus === 'pending' && bookingStatus === 'pending') ? 'block' : 'none';
        } else if (status === 'confirmed') {
            card.style.display = (cardStatus === 'accepted' && bookingStatus === 'confirmed') ? 'block' : 'none';
        } else if (status === 'in_progress') {
            card.style.display = (bookingStatus === 'in_progress') ? 'block' : 'none';
        } else if (status === 'completed') {
            card.style.display = (bookingStatus === 'completed') ? 'block' : 'none';
        } else if (status === 'cancelled') {
            card.style.display = (bookingStatus === 'cancelled') ? 'block' : 'none';
        } else if (status === 'taken') {
            card.style.display = isTakenByOther ? 'block' : 'none';
        }
    });
    
    // Filter table rows
    tableRows.forEach(row => {
        const rowStatus = row.dataset.status;
        const bookingStatus = row.dataset.bookingStatus;
        const bookingMechanic = row.dataset.bookingMechanic;
        const isTakenByOther = bookingStatus === 'confirmed' && rowStatus === 'pending' && bookingMechanic && bookingMechanic !== currentUserId;
        
        if (status === 'all') {
            row.style.display = 'table-row';
        } else if (status === 'pending') {
            row.style.display = (rowStatus === 'pending' && bookingStatus === 'pending') ? 'table-row' : 'none';
        } else if (status === 'confirmed') {
            row.style.display = (rowStatus === 'accepted' && bookingStatus === 'confirmed') ? 'table-row' : 'none';
        } else if (status === 'in_progress') {
            row.style.display = (bookingStatus === 'in_progress') ? 'table-row' : 'none';
        } else if (status === 'completed') {
            row.style.display = (bookingStatus === 'completed') ? 'table-row' : 'none';
        } else if (status === 'cancelled') {
            row.style.display = (bookingStatus === 'cancelled') ? 'table-row' : 'none';
        } else if (status === 'taken') {
            row.style.display = isTakenByOther ? 'table-row' : 'none';
        }
    });
}

// Actual async functions
async function acceptWork(workId) {
    const confirmed = await showConfirmModal('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', '‚úÖ', '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/mechanics/api/queue/${workId}/accept/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            credentials: 'same-origin'
        });
        
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = { error: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ' };
        }
        
        if (response.ok) {
            showDashboardAlert(data.message || '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else if (response.status === 403) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
        } else if (response.status === 404) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        } else {
            showDashboardAlert(data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Accept work error:', error);
        showDashboardAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
    }
}

async function rejectWork(workId) {
    const confirmed = await showConfirmModal('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', '‚ùå', '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/mechanics/api/queue/${workId}/reject/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            credentials: 'same-origin'
        });
        
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = { error: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ' };
        }
        
        if (response.ok) {
            showDashboardAlert(data.message || '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else if (response.status === 403) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
        } else if (response.status === 404) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        } else {
            showDashboardAlert(data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Reject work error:', error);
        showDashboardAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
    }
}

async function startWork(bookingId) {
    const confirmed = await showConfirmModal('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', 'üîß', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/mechanics/api/bookings/${bookingId}/start/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            credentials: 'same-origin'
        });
        
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = { error: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ' };
        }
        
        if (response.ok) {
            showDashboardAlert(data.message || '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else if (response.status === 403) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
        } else if (response.status === 404) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ', 'error');
        } else {
            showDashboardAlert(data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Start work error:', error);
        showDashboardAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
    }
}

async function completeWork(bookingId) {
    const confirmed = await showConfirmModal('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', 'üéâ', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/mechanics/api/bookings/${bookingId}/complete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            credentials: 'same-origin'
        });
        
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = { error: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ' };
        }
        
        if (response.ok) {
            showDashboardAlert(data.message || '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else if (response.status === 403) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
        } else if (response.status === 404) {
            showDashboardAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ', 'error');
        } else {
            showDashboardAlert(data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Complete work error:', error);
        showDashboardAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
    }
}

// ==================== Auto Refresh (Optional) ====================
let autoRefreshInterval = null;

function enableAutoRefresh(intervalMinutes = 5) {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    autoRefreshInterval = setInterval(() => {
        console.log('Auto-refreshing dashboard...');
        window.location.reload();
    }, intervalMinutes * 60 * 1000);
    
    console.log(`Auto-refresh enabled (every ${intervalMinutes} minutes)`);
}

// Uncomment to enable auto-refresh every 5 minutes
// enableAutoRefresh(5);
</script>

    </div>
</div>
{% endblock %}
